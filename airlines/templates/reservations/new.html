{% extends 'base.html' %}
{% load static %}

{% block title %}New Reservation - {{ flight.flight_number }} - Airline: The Primos{% endblock %}

{% block extra_css %}
<style>
    .seat {
    width: 50px;
    height: 50px;
    margin: 4px;
    border: 2px solid #ddd;
    border-radius: 10px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    background-size: 30px 30px;
    background-position: center;
    background-repeat: no-repeat;
}

.seat.available {
    background-color: #d4edda;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23155724'%3E%3Cpath d='M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z'/%3E%3C/svg%3E");
    border-color: #28a745;
    color: #155724;
}
.seat.available:hover {
    background-color: #c3e6cb;
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.seat.occupied {
    background-color: #f8d7da;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23721c24'%3E%3Cpath d='M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z'/%3E%3C/svg%3E");
    border-color: #dc3545;
    color: #721c24;
    cursor: not-allowed;
    opacity: 0.7;
}

.seat.selected {
    background-color: #623ACF;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z'/%3E%3C/svg%3E");
    border-color: #4a2a9f;
    color: white;
    transform: scale(1.15);
    box-shadow: 0 4px 12px rgba(98, 58, 207, 0.4);
}

/* Adding visual distinction for seat classes */
.seat.first {
    border-width: 3px;
    border-color: #FFD700;
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}

.seat.business {
    border-width: 2px;
    border-color: #17a2b8;
    box-shadow: 0 0 6px rgba(23, 162, 184, 0.2);
}

.seat.economy {
    border-width: 2px;
}
/* </CHANGE> */

.row-seat {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.row-number {
    width: 40px;
    text-align: center;
    font-weight: bold;
    margin-right: 15px;
    font-size: 16px;
    color: #333;
}
.aisle {
    width: 40px;
}
.seat-map {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-3">

<!-- Flight Information -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header text-white" style="background-color: #623ACF;">
                <h3 class="mb-0">
                    <i class="fas fa-ticket-alt"></i> New Reservation - {{ flight.flight_number }}
                </h3>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5><i class="fas fa-route"></i> Flight Details</h5>
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div class="text-center">
                                <h5 class="text-success">{{ flight.origin }}</h5>
                                <small>{{ flight.departure_date|date:"m/d/Y H:i" }}</small>
                            </div>
                            <div class="text-center">
                                <i class="fas fa-plane fa-2x" style="color: #623ACF;"></i>
                            </div>
                            <div class="text-center">
                                <h5 class="text-danger">{{ flight.destination }}</h5>
                                <small>{{ flight.arrival_date|date:"m/d/Y H:i" }}</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5><i class="fas fa-user"></i> Passenger Information</h5>
                        <div class="p-3 bg-light rounded">
                            <p class="mb-1"><strong>Name:</strong> {{ passenger.name }}</p>
                            <p class="mb-1"><strong>Document:</strong> {{ passenger.get_document_type_display }}: {{ passenger.document }}</p>
                            <p class="mb-0"><strong>Email:</strong> {{ passenger.email }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Seat Selection -->
<div class="row">
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-th"></i> Select Your Seat
                    <small class="text-muted">({{ total_available }} available)</small>
                </h4>
            </div>
            <div class="card-body">
                <!-- Legend -->
                <div class="mb-4">
                    <h6>Legend:</h6>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div class="seat available economy me-2" style="pointer-events: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#155724" width="30" height="30">
                                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                </svg>
                            </div>
                            <span>Available</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat occupied economy me-2" style="pointer-events: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#721c24" width="30" height="30">
                                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                </svg>
                            </div>
                            <span>Occupied</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat selected economy me-2" style="pointer-events: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white" width="30" height="30">
                                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                </svg>
                            </div>
                            <span>Selected</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat available first me-2" style="pointer-events: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#155724" width="30" height="30">
                                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                </svg>
                            </div>
                            <span>First Class ($$$)</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat available business me-2" style="pointer-events: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#155724" width="30" height="30">
                                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                </svg>
                            </div>
                            <span>Business ($$)</span>
                        </div>
                    </div>
                </div>
                
                <!-- Seat Map -->
                <div class="seat-map text-center">
                    <div class="mb-3">
                        <strong><i class="fas fa-plane"></i> FRONT OF THE PLANE</strong>
                    </div>
                    
                    <form method="post" id="reservationForm">
                        {% csrf_token %}
                        <input type="hidden" name="selected_seat" id="selectedSeat">
                        
                        {% for row, seats in seats_by_row.items %}
                        <div class="row-seat">
                            <div class="row-number">{{ row }}</div>
                            {% for seat_info in seats %}
                                {% if forloop.counter == 3 %}
                                    <div class="aisle"></div>
                                {% endif %}
                                <!-- Fixed seat rendering to show all seats with proper classes -->
                                {% if seat_info.is_occupied %}
                                    <div class="seat occupied {{ seat_info.seat_class }}"
                                        data-seat-id="{{ seat_info.seat.id }}"
                                        data-price="{{ seat_info.price }}"
                                        data-type="{{ seat_info.seat_class }}"
                                        data-number="{{ seat_info.seat.seat_number }}"
                                        title="Occupied - Not Available">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#721c24" width="30" height="30">
                                            <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                        </svg>
                                    </div>
                                {% else %}
                                    <div class="seat available {{ seat_info.seat_class }}"
                                        data-seat-id="{{ seat_info.seat.id }}"
                                        data-price="{{ seat_info.price }}"
                                        data-type="{{ seat_info.seat_class }}"
                                        data-number="{{ seat_info.seat.seat_number }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#155724" width="30" height="30">
                                            <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                                        </svg>
                                    </div>
                                {% endif %}
                                <!-- </CHANGE> -->
                            {% endfor %}
                        </div>
                        {% endfor %}
                        
                        <div class="mt-4">
                            <div class="mb-3">
                                <label for="notes" class="form-label">Remarks (optional)</label>
                                <textarea name="notes" id="notes" class="form-control" rows="2" 
                                          placeholder="Special requests, medical needs, etc."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-lg text-white" style="background-color: #623ACF;" id="btnReserve" disabled>
                                <i class="fas fa-check"></i> Create Reservation
                            </button>
                            <a href="{% url 'flights:detail' flight.id %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Seat Information Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top shadow-sm" style="top: 20px;">
            <div class="card-header text-white" style="background-color: #17a2b8;">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> Seat Information
                </h5>
            </div>
            <div class="card-body" id="seatInfo">
                <div class="text-center text-muted">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#6c757d" width="80" height="80">
                        <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                    </svg>
                    <p class="mt-3">Select a seat to view details</p>
                </div>
            </div>
        </div>
    </div>
</div>

</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedSeatElement = null;

function selectSeat(element) {
    // Check if seat is occupied
    if (element.classList.contains('occupied')) {
        alert("This seat is not available.");
        return;
    }

    // Deselect previous seat
    if (selectedSeatElement) {
        selectedSeatElement.classList.remove('selected');
        const prevSvg = selectedSeatElement.querySelector('svg');
        if (prevSvg) prevSvg.setAttribute('fill', '#155724');
    }
    
    // Select new seat
    element.classList.add('selected');
    const svg = element.querySelector('svg');
    if (svg) svg.setAttribute('fill', 'white');
    
    selectedSeatElement = element;

    // Update form and button
    document.getElementById('selectedSeat').value = element.dataset.seatId;
    document.getElementById('btnReserve').disabled = false;
    
    // Update info panel
    updateSeatInfo(element);
}

function updateSeatInfo(element) {
    const infoPanel = document.getElementById('seatInfo');
    const price = parseFloat(element.dataset.price) || 0;
    const seatClass = element.dataset.type || 'economy';
    
    const classNames = {
        'first': 'First Class',
        'business': 'Business Class',
        'economy': 'Economy Class'
    };
    
    const classInfo = {
        'first': 'Includes: Gourmet meal, premium drinks, reclining seat, extra baggage.',
        'business': 'Includes: Enhanced meal, drinks, comfortable seat, additional baggage.',
        'economy': 'Includes: Snack, drink, standard carry-on baggage.'
    };

    infoPanel.innerHTML = `
        <div class="text-center">
            <div class="mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#623ACF" width="80" height="80">
                    <path d="M4 18v3h3v-3h10v3h3v-6H4v3zm15-8h3v3h-3v-3zM2 10h3v3H2v-3zm15 3H7V5c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v8z"/>
                </svg>
            </div>
            <h5>Seat ${element.dataset.number}</h5>
            <p class="mb-2"><strong>Class:</strong> ${classNames[seatClass] || 'Standard'}</p>
            <h4 class="text-success mb-3">$${price.toFixed(2)}</h4>
            <div class="alert alert-info">
                <small><i class="fas fa-info-circle"></i> ${classInfo[seatClass] || 'Standard class.'}</small>
            </div>
        </div>
    `;
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    const availableSeats = document.querySelectorAll('.seat.available');
    
    availableSeats.forEach(seat => {
        // Add click handler
        seat.addEventListener('click', function() {
            selectSeat(this);
        });
        
        // Add tooltip
        const price = parseFloat(seat.dataset.price) || 0;
        const seatClass = seat.dataset.type || 'economy';
        const classNames = {
            'first': 'First Class',
            'business': 'Business Class',
            'economy': 'Economy Class'
        };
        seat.title = `Seat ${seat.dataset.number} - ${classNames[seatClass]} - $${price.toFixed(2)}`;
    });
});
</script>
{% endblock %}
